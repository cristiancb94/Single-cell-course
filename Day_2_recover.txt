##Running trimmomatic##
ILLUMINACLIP specifying the sequence of the adaptors  xyz (x number of mismatchs 2) (y = in pair end library it will trimm until it reaches a score of 30 it will be clipped) (z= score value for single end data)
LEADING and TRAILING remove low quality or N bases (below quality 3) 
SLIDINGWINDOW Scan the reads with a window of x and then if the quality goes below y remove (SLIDINGWINDOW 6:15) if the average quality falls bellow 15 which is basically 1 nucleotide per every 50bp (approximately). Everything that is from there on is trimmed 
MINLEN:75 Reads that should survive because if you keep shorter sequences 

# # Work dependencies # # 
#The id_job is for the job that you already run h
sbatch --dependency=afterok:9519511 star.sh

#Samtools view
SRR24348395.6684622     419     NC_064034.1     53353   0       79S71M1S        =       53488   286     GTCAAAATCTCAATTAGTGTAAAATGGATTTGTGGTTACCGCCGCTTGCACGCGGCCACTAAAATCTAGAATCTAAAATCAAATTTTGTTTGATTTAAGAGTTGAATCCATGTTTTCAAAATTATTAAATTGTTCTTCATTTAAGTTTTTA FFFFFFF:FFFFF,FFFF:FF:FFFF:FFFFFFFFFFFFFFFFFFFFFFFFFF,FF,F:FFFF,F:FF:FFFFFFFFFF,FFFFFFF:F:FFFFFFFFFF:FFFFFFFF:FFFFFFFFFFFFFFFFFFFFFFFF:FFF,FFFF,FFFFFF, NH:i:6  HI:i:6  AS:i:216        nM:i:2

#NC_064034.1 Region to which the read was mapped

Where to check the flags from SAM files
https://broadinstitute.github.io/picard/explain-flags.html (Second column)
The "=" means that they forward or reverse mapped to the same region
The fifth column gives the mapping quality, if 0 it means that is a multimapper and wont be included for further analysis
Optional fields nM: i: 2 number of matches 

##Retrieving sequences using samtools
#First do the index from .fasta
samtools faidx reference.fasta NC_064034.1:1500000-1501000  #The last parameter is the location of the sequence of interest 
#First do the index from .bam
samtools index SRR24348395Aligned.sortedByCoord.out.bam
samtools view SRR24348395Aligned.sortedByCoord.out.bam NC_064034.1:1500000-1501000

#Checking the quality of the libraries using FASTQC
[barrera@login01 trim]$ module load fastqc
[barrera@login01 trim]$ fastqc -t 8 SRR24348395_R1.qc.fastq SRR24348395_R2.qc.fastq

#Taking files from the cluster
scp barrera@login01.lisc.univie.ac.at:/scratch/course/2023w300106/barrera/ex_5/SRR24348395/trim/SRR24348395_R2.qc_fastqc.html .
#Analyzong the fastqc
Per sequence GC content
  If there are two peaks it means that there is a signature of contamination with another organisms

##Day 3##
Generation of information about gene positions by mapping RNA-seq
  All reads belong to genes but you may not get all of the mRNAs: How to solve it? Different tissue/stages/deeper sequencing 
#If you have an argument in a program something like:
  <in.bam ...> #In this case we can input several files 
#In the case of stringtie it uses .bam files from RNA-seq to assemble those into potential transcripts 
  -g maximum gap allowed between read mappings (50) distance between the mappings - can be due low sequencing depth  (below this value it will be considered the same gene)
  -m the transcript length that can be accepted. It should be the size of at least one read (will use 150)
  -j how much evidence you need to merge two exons together  (1)
  -f isoforms  Proportion of read that should support a model in order to it be considered correct (default 0.01) if is present less than 100 down is ignored
  -M (Usually multimapped reads are not alllowed)
  -A gene abundance stimation output file

Stringtie merge

##Filtering of the .bam file##
Yesterday we saw that multimapping have quality of 0, then we will use -q 20 (1 in 100 probability of being wrong, i am keeping reads that have probability of 1% of being wrong)
Read should mapp into forward and reverse maps (if that is not the case we can exclude specific flags ) in this case we are requiring (0x2)
samtools view -b -o -q 20 /scratch/course/2023w300106/BAMS/SRR24348395.f.bam /scratch/course/2023w300106/barrera/ex4/SRR24348395_trim_Aligned.sortedByCoord.out.bam 

#Wildcard
*.bam -> This will match all files that finish in .bam
# dependency
sbatch --dependency=afterok: 9523010, xxxx, xxx myProgram.sh 

#Error in stringtie, there are not assigned strands to the reads

####Library normalization
It has to occur intra normalization which accounts for the size of the genes
Also occurs inter normalization 


###IGV
The IGV need to download the genome and the GTF too
## The distance in the gene models if supported it does not matter

#Coverage tells you info about the intergenic regions
#Junctions (It says which exons belong together to the same molecule)
Color of the junctions is indicating the strand 

#From the gene models you can compare sequences of proteins from different organisms

###Running augustus 
  #We split the genome
  #Samtools to extract chromosome sequences
  To check the ID of the chromosome we use the .fai which is the output of doing the index
samtools faidx GCF_932526225.1_jaNemVect1.1_genomic.fna NC_064034.1 > chr1.fasta

#--strand=both --genemodel=complete / can be also partial
--hintsfile = hintsfilename
--alternative evidence false (isoforms)
-gff = on 

### generating count matrix
Doing the count "manually"
samtools view SRR24348395_trim_Aligned.sortedByCoord.out.bam NC_064034.1:372944-378001 | wc -l
1012
This has a problem because you can count twice the reads that are aligned to the forward or the reverse strand.
  In general take the gene coordinates, then look which genes aling there. 
  For this purpose you need the .gtf and the .bam file 

#Converting the .gff to .gtf
[barrera@login02 GCF_932526225.1]$ module load gffread
[barrera@login02 GCF_932526225.1]$ gffread -T -o jaNemvec1.1.gtf genomic.gff

#Summarize 
Input .bam file and .gtf file and will generate a matrix count
[barrera@login02 GCF_932526225.1]$ module load subread
featureCounts #run an script for this program 
Will group the counts for exons 

## One of the possible solutions##
A lot of reads downstream of my genes (space of the genome that is empty)
  -readExtensions3 (Useful in my case!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!)
  -The nature of single cell sequencing enrich the 3' of the sequence 

--ignoreDup ###Useful for the presence of duplicates in the dataset
##Strandness
  -s Perform strand specific read counting (for most libraries we use the most commong standard ) which is 1 (stranded)
  -p specifiying pair end reads
  -C do not count read pairs that have their two ends mappind to different chromosomes 
  
